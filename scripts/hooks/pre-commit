#!/bin/bash

set -e

TMPFILE=$(mktemp)
trap "rm -f $TMPFILE" EXIT

run_check() {
    local name="$1"
    shift
    if "$@" > "$TMPFILE" 2>&1; then
        return 0
    else
        echo ""
        echo "❌ $name failed:"
        cat "$TMPFILE"
        return 1
    fi
}

# Run checks in bae-core directory
cd bae-core

run_check "cargo fmt (bae-core)" cargo fmt -- --check || {
    echo "Run 'cargo fmt' in the bae-core directory to fix formatting"
    exit 1
}

run_check "clippy lib (bae-core)" cargo clippy --lib -- -D warnings -A unexpected_cfgs -A deprecated || {
    echo "Fix the warnings above and try again"
    exit 1
}

run_check "clippy tests (bae-core)" cargo clippy --tests --features test-utils -- -D warnings -A unexpected_cfgs -A deprecated || {
    echo "Fix the warnings above and try again"
    exit 1
}

for test in tests/*.rs; do
    testname=$(basename "$test" .rs)
    run_check "clippy integration test: $testname" cargo clippy --test "$testname" --features test-utils -- -D warnings -A unexpected_cfgs -A deprecated || {
        exit 1
    }
done

cd ..

# Run checks in bae-desktop directory
cd bae-desktop

run_check "cargo fmt (bae-desktop)" cargo fmt -- --check || {
    echo "Run 'cargo fmt' in the bae-desktop directory to fix formatting"
    exit 1
}

run_check "dx fmt (bae-desktop)" dx fmt --check || {
    echo "Run 'dx fmt' in the bae-desktop directory to fix formatting"
    exit 1
}

run_check "clippy (bae-desktop)" env BINDGEN_EXTRA_CLANG_ARGS="-I/opt/homebrew/include" cargo clippy -- -D warnings -A unexpected_cfgs -A deprecated || {
    echo "Fix the warnings above and try again"
    exit 1
}

cd ..

# Run checks in bae-ui directory
cd bae-ui

run_check "cargo fmt (bae-ui)" cargo fmt -- --check || {
    echo "Run 'cargo fmt' in the bae-ui directory to fix formatting"
    exit 1
}

run_check "clippy (bae-ui)" cargo clippy -- -D warnings || {
    echo "Fix the warnings above and try again"
    exit 1
}

cd ..

# Run checks in bae-demo directory
cd bae-demo

run_check "cargo fmt (bae-demo)" cargo fmt -- --check || {
    echo "Run 'cargo fmt' in the bae-demo directory to fix formatting"
    exit 1
}

run_check "dx fmt (bae-demo)" dx fmt --check || {
    echo "Run 'dx fmt' in the bae-demo directory to fix formatting"
    exit 1
}

run_check "clippy (bae-demo)" cargo clippy -- -D warnings || {
    echo "Fix the warnings above and try again"
    exit 1
}

cd ../bae-core

run_check "tests (bae-core)" cargo test --features test-utils || {
    echo "Fix the failing tests and try again"
    exit 1
}

echo "✅ All checks passed"
exit 0
